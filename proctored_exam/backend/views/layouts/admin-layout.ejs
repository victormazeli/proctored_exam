<!-- views/layouts/admin-layout.ejs -->
<%- include('./base-layout', {
  title: title ? title + ' | Admin' : 'Admin',
  layoutCSS: 'admin',
  bodyClass: 'min-h-screen flex bg-gray-100 text-gray-800'
}) %>

<!-- Sidebar -->
<aside class="admin-sidebar bg-gray-800 text-white w-64 flex-shrink-0 hidden md:block">
  <div class="sidebar-header p-4 border-b border-gray-700">
    <div class="flex items-center">
      <img class="h-8 w-auto mr-3" src="/images/logo-white.svg" alt="Logo">
      <div>
        <h1 class="text-lg font-semibold">Admin Panel</h1>
        <p class="text-xs text-gray-400">Certification Practice Platform</p>
      </div>
    </div>
  </div>
  
  <nav class="sidebar-nav p-4">
    <ul class="space-y-1">
      <li>
        <a href="/admin" class="nav-item <%= path === '/admin' ? 'active' : '' %>">
          <i class="fas fa-tachometer-alt"></i>
          <span>Dashboard</span>
        </a>
      </li>
      
      <li class="nav-section">
        <span class="nav-section-title">Content Management</span>
      </li>
      <li>
        <a href="/admin/certifications" class="nav-item <%= path === '/admin/certifications' ? 'active' : '' %>">
          <i class="fas fa-certificate"></i>
          <span>Certifications</span>
        </a>
      </li>
      <li>
        <a href="/admin/exams" class="nav-item <%= path === '/admin/exams' ? 'active' : '' %>">
          <i class="fas fa-file-alt"></i>
          <span>Exams</span>
        </a>
      </li>
      <li>
        <a href="/admin/questions" class="nav-item <%= path === '/admin/questions' ? 'active' : '' %>">
          <i class="fas fa-question-circle"></i>
          <span>Questions</span>
        </a>
      </li>
      
      <li class="nav-section">
        <span class="nav-section-title">Users & Analytics</span>
      </li>
      <li>
        <a href="/admin/users" class="nav-item <%= path === '/admin/users' ? 'active' : '' %>">
          <i class="fas fa-users"></i>
          <span>Users</span>
        </a>
      </li>
      <li>
        <a href="/admin/analytics" class="nav-item <%= path === '/admin/analytics' ? 'active' : '' %>">
          <i class="fas fa-chart-bar"></i>
          <span>Analytics</span>
        </a>
      </li>
      
      <li class="nav-section">
        <span class="nav-section-title">Monitoring</span>
      </li>
      <li>
        <a href="/admin/active-exams" class="nav-item <%= path === '/admin/active-exams' ? 'active' : '' %>">
          <i class="fas fa-video"></i>
          <span>Active Proctored Exams</span>
          <span id="active-exams-count" class="nav-badge">0</span>
        </a>
      </li>
      <li>
        <a href="/admin/flagged-questions" class="nav-item <%= path === '/admin/flagged-questions' ? 'active' : '' %>">
          <i class="fas fa-flag"></i>
          <span>Flagged Questions</span>
          <span id="flagged-questions-count" class="nav-badge">0</span>
        </a>
      </li>
    </ul>
  </nav>
  
  <div class="sidebar-footer p-4 mt-auto border-t border-gray-700">
    <div class="flex items-center">
      <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center mr-3">
        <span class="text-sm font-medium">
          <%= user ? user.username.substring(0, 2).toUpperCase() : 'AD' %>
        </span>
      </div>
      <div>
        <p class="text-sm font-medium"><%= user ? user.username : 'Admin' %></p>
        <p class="text-xs text-gray-400">Administrator</p>
      </div>
    </div>
    <div class="mt-3 flex justify-between">
      <a href="/auth/profile" class="text-xs text-gray-400 hover:text-white">Profile</a>
      <a href="/auth/logout" class="text-xs text-gray-400 hover:text-white">Logout</a>
    </div>
  </div>
</aside>

<!-- Mobile sidebar toggle and header -->
<div class="md:hidden fixed top-0 left-0 right-0 z-30 bg-gray-800 text-white">
  <div class="flex items-center justify-between p-4">
    <button id="mobile-menu-toggle" class="block text-white focus:outline-none">
      <i class="fas fa-bars"></i>
    </button>
    <div class="flex items-center">
      <img class="h-8 w-auto mr-3" src="/images/logo-white.svg" alt="Logo">
      <h1 class="text-lg font-semibold">Admin Panel</h1>
    </div>
    <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center">
      <span class="text-sm font-medium">
        <%= user ? user.username.substring(0, 2).toUpperCase() : 'AD' %>
      </span>
    </div>
  </div>
</div>

<!-- Mobile Sidebar (hidden by default) -->
<div id="mobile-sidebar" class="fixed inset-0 z-20 transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden">
  <div class="absolute inset-0 bg-gray-900 opacity-50" id="mobile-sidebar-backdrop"></div>
  <div class="absolute left-0 top-0 bottom-0 w-64 bg-gray-800 text-white">
    <!-- Mobile sidebar content (clone of desktop sidebar) -->
    <div class="sidebar-header p-4 border-b border-gray-700 mt-16">
      <div class="flex items-center">
        <img class="h-8 w-auto mr-3" src="/images/logo-white.svg" alt="Logo">
        <div>
          <h1 class="text-lg font-semibold">Admin Panel</h1>
          <p class="text-xs text-gray-400">Certification Practice Platform</p>
        </div>
      </div>
    </div>
    
    <nav class="sidebar-nav p-4">
      <ul class="space-y-1">
        <li>
          <a href="/admin" class="nav-item <%= path === '/admin' ? 'active' : '' %>">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
        </li>
        
        <li class="nav-section">
          <span class="nav-section-title">Content Management</span>
        </li>
        <li>
          <a href="/admin/certifications" class="nav-item <%= path === '/admin/certifications' ? 'active' : '' %>">
            <i class="fas fa-certificate"></i>
            <span>Certifications</span>
          </a>
        </li>
        <li>
          <a href="/admin/exams" class="nav-item <%= path === '/admin/exams' ? 'active' : '' %>">
            <i class="fas fa-file-alt"></i>
            <span>Exams</span>
          </a>
        </li>
        <li>
          <a href="/admin/questions" class="nav-item <%= path === '/admin/questions' ? 'active' : '' %>">
            <i class="fas fa-question-circle"></i>
            <span>Questions</span>
          </a>
        </li>
        
        <li class="nav-section">
          <span class="nav-section-title">Users & Analytics</span>
        </li>
        <li>
          <a href="/admin/users" class="nav-item <%= path === '/admin/users' ? 'active' : '' %>">
            <i class="fas fa-users"></i>
            <span>Users</span>
          </a>
        </li>
        <li>
          <a href="/admin/analytics" class="nav-item <%= path === '/admin/analytics' ? 'active' : '' %>">
            <i class="fas fa-chart-bar"></i>
            <span>Analytics</span>
          </a>
        </li>
        
        <li class="nav-section">
          <span class="nav-section-title">Monitoring</span>
        </li>
        <li>
          <a href="/admin/active-exams" class="nav-item <%= path === '/admin/active-exams' ? 'active' : '' %>">
            <i class="fas fa-video"></i>
            <span>Active Proctored Exams</span>
            <span id="mobile-active-exams-count" class="nav-badge">0</span>
          </a>
        </li>
        <li>
          <a href="/admin/flagged-questions" class="nav-item <%= path === '/admin/flagged-questions' ? 'active' : '' %>">
            <i class="fas fa-flag"></i>
            <span>Flagged Questions</span>
            <span id="mobile-flagged-questions-count" class="nav-badge">0</span>
          </a>
        </li>
      </ul>
    </nav>
    
    <div class="sidebar-footer p-4 mt-auto border-t border-gray-700">
      <div class="flex items-center">
        <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center mr-3">
          <span class="text-sm font-medium">
            <%= user ? user.username.substring(0, 2).toUpperCase() : 'AD' %>
          </span>
        </div>
        <div>
          <p class="text-sm font-medium"><%= user ? user.username : 'Admin' %></p>
          <p class="text-xs text-gray-400">Administrator</p>
        </div>
      </div>
      <div class="mt-3 flex justify-between">
        <a href="/auth/profile" class="text-xs text-gray-400 hover:text-white">Profile</a>
        <a href="/auth/logout" class="text-xs text-gray-400 hover:text-white">Logout</a>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="admin-content flex-grow md:ml-64 mt-16 md:mt-0">
  <div class="p-6">
    <%- body %>
  </div>
</div>

<style>
  /* Admin Layout Styles */
  .admin-sidebar {
    @apply fixed inset-y-0 left-0 z-20 flex flex-col;
    width: 16rem;
  }
  
  .admin-content {
    @apply w-full min-h-screen;
  }
  
  .nav-section {
    @apply mt-6 mb-2;
  }
  
  .nav-section-title {
    @apply block px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider;
  }
  
  .nav-item {
    @apply flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white transition-colors;
  }
  
  .nav-item i {
    @apply w-5 text-center mr-3;
  }
  
  .nav-item.active {
    @apply bg-gray-900 text-white;
  }
  
  .nav-badge {
    @apply ml-auto text-xs bg-gray-700 text-gray-300 rounded-full w-5 h-5 flex items-center justify-center;
  }
  
  .nav-badge.has-count {
    @apply bg-red-500 text-white;
  }
  
  .fade-out {
    @apply opacity-0 transition-opacity duration-300;
  }
  
  @media (min-width: 768px) {
    .admin-content {
      margin-left: 16rem;
    }
  }
</style>

<script>
  // Mobile menu toggle
  document.addEventListener('DOMContentLoaded', function() {
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const mobileSidebar = document.getElementById('mobile-sidebar');
    const mobileSidebarBackdrop = document.getElementById('mobile-sidebar-backdrop');
    
    mobileMenuToggle.addEventListener('click', function() {
      mobileSidebar.classList.toggle('-translate-x-full');
    });
    
    mobileSidebarBackdrop.addEventListener('click', function() {
      mobileSidebar.classList.add('-translate-x-full');
    });
    
    // Fetch active counts for badges
    fetchActiveCounts();
    
    // Refresh counts every 60 seconds
    setInterval(fetchActiveCounts, 60000);
  });
  
  // Fetch active counts for the badges
  function fetchActiveCounts() {
    // Fetch active exams count
    fetch('/admin/active-exams/count')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const count = data.count;
          const countElement = document.getElementById('active-exams-count');
          const mobileCountElement = document.getElementById('mobile-active-exams-count');
          
          countElement.textContent = count;
          mobileCountElement.textContent = count;
          
          if (count > 0) {
            countElement.classList.add('has-count');
            mobileCountElement.classList.add('has-count');
          } else {
            countElement.classList.remove('has-count');
            mobileCountElement.classList.remove('has-count');
          }
        }
      })
      .catch(error => console.error('Error fetching active exams count:', error));
    
    // Fetch flagged questions count
    fetch('/admin/flagged-questions/count')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const count = data.count;
          const countElement = document.getElementById('flagged-questions-count');
          const mobileCountElement = document.getElementById('mobile-flagged-questions-count');
          
          countElement.textContent = count;
          mobileCountElement.textContent = count;
          
          if (count > 0) {
            countElement.classList.add('has-count');
            mobileCountElement.classList.add('has-count');
          } else {
            countElement.classList.remove('has-count');
            mobileCountElement.classList.remove('has-count');
          }
        }
      })
      .catch(error => console.error('Error fetching flagged questions count:', error));
  }
</script>